(function(a){function c(b,c){var d=c.getContext("2d");var e=b.data("spidergraph");var f=360/e.settings.fields.length;var i=e.cx;var j=e.cy;var l=e.radius;var m=e.settings.increments;var n=e.settings.minrad;d.clearRect(0,0,c.width,c.height);for(var o=0;o<m;o++){g(d,i,j,(o+1)/m*l+n,e.settings.gridcolor,.3)}for(var o=0;o<e.settings.fields.length;o++){var p=o*f*Math.PI/180;var q=m/m*l+n;var r=Math.sin(p)*q;var s=0-Math.cos(p)*q;k(d,i,j,r+i,s+j,e.settings.gridcolor,.3)}b.find(".diagramText").remove();for(var o=0;o<e.settings.fields.length;o++){var p=o*f*Math.PI/180;var q=m/m*l+n+10;var r=Math.sin(p)*q;var s=0-Math.cos(p)*q;var t=e.settings.fields[o];var u=e.cx;var v=e.cy;$newtext=a("<div>");$newtext.text(t);$newtext.addClass("diagramText");$newtext.css({display:"block",position:"absolute",left:u+r+"px",top:v+s+"px"});b.prepend($newtext);var w=$newtext.width()/2+Math.cos(p+Math.PI/2)*$newtext.width()/2;var x=$newtext.height()/2+Math.cos(p)*$newtext.height()/2;$newtext.css({display:"block",position:"absolute",left:u+r-w+"px",top:v+s-x+"px"})}h(d,i,j,e.settings.handlewidth,e.settings.dotcolor)}function d(a,b){var c=b.getContext("2d");var d=a.data("spidergraph");c.clearRect(0,0,b.width,b.height);for(var e in d.fixeddata){layerdata=d.fixeddata[e];f(a,b,layerdata)}}function e(a,b){var c=b.getContext("2d");var d=a.data("spidergraph");c.clearRect(0,0,b.width,b.height);if(d==null||d.activedata==null||d.activedata.data==null){return}layerdata=d.activedata;f(a,b,layerdata)}function f(a,b,c){var d=b.getContext("2d");var e=a.data("spidergraph");var f=360/e.settings.fields.length;var g=e.cx;var h=e.cy;var j=e.radius;var k=e.settings.increments;var l=e.settings.minrad;d.strokeStyle=c.strokecolor;d.fillStyle=c.fillcolor;d.lineWidth=e.settings.strokewidth;d.beginPath();for(var n=0;n<e.settings.fields.length;n++){var o=i(a,c.data,n);var p=i(a,c.data,(n+1)%e.settings.fields.length);var q=i(a,c.data,(n+2)%e.settings.fields.length);var r=i(a,c.data,n-1>=0?n-1:e.settings.fields.length-1);var s=Math.sqrt((q.x-o.x)*(q.x-o.x)+(q.y-o.y)*(q.y-o.y));s=s*.2*.2*((c.data[n]+2)/k+4);var t=Math.sqrt((p.x-r.x)*(p.x-r.x)+(p.y-r.y)*(p.y-r.y));t=t*.2*.2*((c.data[(n+1)%e.settings.fields.length]+2)/k+4);var u=Math.sqrt((p.x-r.x)*(p.x-r.x)+(p.y-r.y)*(p.y-r.y));u=s/u;var v=Math.sqrt((q.x-o.x)*(q.x-o.x)+(q.y-o.y)*(q.y-o.y));v=t/v;exit={x:(p.x-r.x)*u+o.x,y:(p.y-r.y)*u+o.y};approach={x:p.x-(q.x-o.x)*v,y:p.y-(q.y-o.y)*v};if(n==0){d.moveTo(Math.floor(o.x+g),Math.floor(o.y+h))}m(d,o.x+g,o.y+h,exit.x+g,exit.y+h,approach.x+g,approach.y+h,p.x+g,p.y+h,c.strokecolor)}d.fill();d.stroke()}function g(a,b,c,d,e,f){a.strokeStyle=e;a.lineWidth=f;a.beginPath();a.arc(Math.floor(b),Math.floor(c),d,0,Math.PI*2,true);a.closePath();a.stroke()}function h(a,b,c,d,e){a.fillStyle=e;a.beginPath();a.arc(Math.floor(b),Math.floor(c),d,0,Math.PI*2,true);a.closePath();a.fill()}function i(a,b,c){var d=a.data("spidergraph");degstep=360/b.length;var e=c*degstep*Math.PI/180;var f=b[c]/d.settings.increments*d.radius+d.settings.minrad;var g=Math.sin(e)*f;var h=0-Math.cos(e)*f;return{x:g,y:h,r:f}}function j(a,b,c,d,e,f,g,h){a.fillStyle=h;a.beginPath();a.moveTo(Math.floor(b),Math.floor(c));a.lineTo(Math.floor(d),Math.floor(e));a.lineTo(Math.floor(f),Math.floor(g));a.lineTo(Math.floor(b),Math.floor(c));a.fill()}function k(a,b,c,d,e,f,g){a.strokeStyle=f;a.lineWidth=g;a.beginPath();a.moveTo(Math.floor(b),Math.floor(c));a.lineTo(Math.floor(d),Math.floor(e));a.stroke()}function l(a,b,c,d,e,f,g,h,i,j){a.strokeStyle=j;a.lineWidth=stroke;a.beginPath();a.moveTo(Math.floor(b),Math.floor(c));a.bezierCurveTo(Math.floor(d),Math.floor(e),Math.floor(f),Math.floor(g),Math.floor(h),Math.floor(i));a.stroke()}function m(a,b,c,d,e,f,g,h,i){a.bezierCurveTo(Math.floor(d),Math.floor(e),Math.floor(f),Math.floor(g),Math.floor(h),Math.floor(i))}var b={init:function(b){var d={fields:["Field 1","Field 2","Field 3"],gridcolor:"rgba(0,0,0,0.4)",dotcolor:"rgba(0,0,0,.6)",strokewidth:4,handlewidth:4,increments:10,minrad:10};return this.each(function(){if(this.tagName.toUpperCase()!="DIV"){return false}if(b){a.extend(d,b)}var f;var g;var h;var i;var j;var k;var l;var m;var n;var o;var p;var q=d["minrad"];var r={};var s=[];var t=d["increments"];var u=d["strokewidth"];var v=d["handlewidth"];var w=false;var x=0;var y=false;i=a(this).get(0);j=a('<div class="spidergraph" style="width:100%;height:100%;padding:0;margin:0;border:0" />').get(0);a(i).children().remove();a(i).append(a(j));n=Math.floor(a(j).width()/2-v/2);o=Math.floor(a(j).height()/2-v/2);p=a(j).width();if(a(j).height()<a(j).width()){p=a(j).height()}p=Math.floor(p/2-50);f=a("<canvas>").get(0);a(f).css({position:"absolute",top:"0px",left:"0px"});g=a("<canvas>").get(0);a(g).css({position:"absolute",top:"0px",left:"0px"});h=a("<canvas>").get(0);a(h).css({position:"absolute",top:"0px",left:"0px"});g.width=a(j).width();f.width=a(j).width();h.width=a(j).width();g.height=a(j).height();f.height=a(j).height();h.height=a(j).height();a(j).append(a(g));a(j).append(a(h));a(j).append(a(f));k=f.getContext("2d");l=g.getContext("2d");m=g.getContext("2d");a(this).data("spidergraph",{settings:d,outercontainer:i,activedata:r,fixeddata:s,canvasbg:g,canvasfg:f,canvasfixed:h,cx:n,cy:o,radius:p});var z=a(this).data("spidergraph");var A=a(this);var B=function(b){var c=Math.floor(b.pageX-a(j).offset().left);var e=Math.floor(b.pageY-a(j).offset().top);var f=c-n;var g=e-o;var h=Math.sqrt(f*f+g*g);var i=Math.atan(f/(0-g));var k=i*180/Math.PI;if(g>0){k+=180}if(g<=0&&f<0){k+=360}var l=180;var m=0;degstep=360/d.fields.length;for(var p=0;p<d.fields.length;p++){var q=p*degstep;var r=Math.abs(k-q)%360;if(r>180){r=360-r}if(r<l){m=p;l=r}}x=m};var C=function(b){var c=Math.floor(b.pageX-a(j).offset().left);var f=Math.floor(b.pageY-a(j).offset().top);var g=c-n;var h=f-o;var i=Math.sqrt(g*g+h*h);var k=Math.atan(g/(0-h));var l=k*180/Math.PI;if(h>0){l+=180}if(h<=0&&g<0){l+=360}var m=180;var q=0;degstep=360/d.fields.length;for(var r=0;r<d.fields.length;r++){var s=r*degstep;var u=Math.abs(l-s)%360;if(u>180){u=360-u}if(u<m){q=r;m=u}}if(q!=x){}var v=i/p*t;v=Math.floor(v);if(v>t){v=t}else if(v<0){v=0}if(z.activedata.data){z.activedata.data[x]=v;A.trigger("spiderdatachange",[z.activedata.data]);e(A,z.canvasfg)}};var D="createTouch"in document;var E=D?"click":"click";var F=D?"touchstart":"mousedown";var G=D?"touchmove":"mousemove";var H=D?"touchend":"mouseup";var I=function(a){if(D){a.pageX=a.originalEvent.targetTouches[0].pageX;a.pageY=a.originalEvent.targetTouches[0].pageY}};a(j).bind(F,function(a){w=true;I(a);if(a.correctedX!=0&&a.correctedY!=0){y=true;B(a);C(a)}});a(j).bind(H,function(a){w=false});a(window).bind(H,function(a){w=false});a(j).bind(G,function(a){I(a);if(w&&y){C(a)}else if(w){alert("loc: "+ev.pageX+" "+ev.pageY);y=true;B(a);C(a)}});c(a(this),g)})},addlayer:function(b){var c=a(this).data("spidergraph");c.fixeddata[c.fixeddata.length]=b;d(a(this),c.canvasfixed)},redraw:function(){var b=a(this).data("spidergraph");c(a(this),b.canvasbg);d(a(this),b.canvasfixed);e(a(this),b.canvasfg)},resetdata:function(){var b=a(this).data("spidergraph");b.fixeddata=[];b.activedata={};c(a(this),b.canvasbg);d(a(this),b.canvasfixed);e(a(this),b.canvasfg)},setactivedata:function(b){var c=a(this).data("spidergraph");c.activedata=b;e(a(this),c.canvasfg)}};jQuery.fn.spidergraph=function(c){if(b[c]){return b[c].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof c==="object"||!c){return b.init.apply(this,arguments)}else{a.error("Method "+c+" does not exist on jQuery.spidergraph")}}})(jQuery)
